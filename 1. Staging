-- create DB

create database IMT_577_512_DB_MAX_MILLER;

-- Create warehouse

create warehouse IMT_577_512_DW_MAX_MILLER WITH WAREHOUSE_SIZE = 'XSMALL' AUTO_SUSPEND = 600 AUTO_RESUME = TRUE COMMENT = '';


-- Create stages to start importing data from CSVs

CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".CHANNEL_STAGE URL = 'azure://sp72storage.blob.core.windows.net/channel' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".CHANNEL_CATEGORY_STAGE URL = 'azure://sp72storage.blob.core.windows.net/channelcategory' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".CUSTOMER_STAGE URL = 'azure://sp72storage.blob.core.windows.net/customer' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".PRODUCT_STAGE URL = 'azure://sp72storage.blob.core.windows.net/product' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".PRODUCT_CATEGORY_STAGE URL = 'azure://sp72storage.blob.core.windows.net/productcategory' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".PRODUCT_TYPE_STAGE URL = 'azure://sp72storage.blob.core.windows.net/producttype' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".RESELLER_STAGE URL = 'azure://sp72storage.blob.core.windows.net/reseller' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".SALES_DETAIL_STAGE URL = 'azure://sp72storage.blob.core.windows.net/salesdetail' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".SALES_HEADER_STAGE URL = 'azure://sp72storage.blob.core.windows.net/salesheader' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');


CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".STORE_STAGE URL = 'azure://sp72storage.blob.core.windows.net/store' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".TARGET_DATA_CHANNEL_STAGE URL = 'azure://sp72storage.blob.core.windows.net/targetdatachannel' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

CREATE STAGE "IMT_577_512_DB_MAX_MILLER"."PUBLIC".TARGET_DATA_PRODUCT_STAGE URL = 'azure://sp72storage.blob.core.windows.net/targetdataproduct' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

-- Set up to import data from CSV files,s eparating fields by commas and quotes and skipping the top row

Create file format CSV_SKIP_HEADER
type = 'CSV'
field_delimiter = ','
field_optionally_enclosed_by = '"'
skip_header = 1;

-- Create staing tables

create table STAGE_CHANNEL (
    CHANNEL_ID INT,
    CHANNEL_CATEGORY_ID INT,
    CHANNEL VARCHAR(255),
    CREATED_DATE VARCHAR(255),
    CRATED_BY VARCHAR(255),
    MODIFIED_DATE VARCHAR(255),
    MODIFIED_BY VARCHAR(255)
);

create table STAGE_CHANNEL_CATEGORY (
    CHANNEL_CATEGORY_ID INT,
    CHANNEL_CATEGORY VARCHAR (255),
    CREATED_DATE VARCHAR (255),
    CREATED_BY VARCHAR(255),
    MODIFIED_DATE VARCHAR (255),
    MODIFIED_BY VARCHAR (255)
);


create table STAGE_CUSTOMER (
    CUSTOMER_ID VARCHAR(255),
    SUBSEGMENT INT,
    FIRSTNAME VARCHAR (255),
    LASTNAME VARCHAR (255),
    GENDER VARCHAR (255),
    EMAIL_ADDRESS VARCHAR (255),
    ADDRESS VARCHAR (255),
    CITY VARCHAR (255),
    STATEPROVINCE VARCHAR (255),
    COUNTRY VARCHAR (255),
    POSTAL_CODE INT,
    PHONE_NUMBER VARCHAR (255),
    CREATED_DATE VARCHAR(255),
    CREATED_BY VARCHAR (255),
    MODIFIED_DATE VARCHAR(255),
    MODIFIED_BY VARCHAR (255)

);

create table STAGE_PRODUCT (
    PRODUCT_ID INT,
    PRODUCT_TYPE INT,
    PRODUCT VARCHAR (255),
    COLOR  VARCHAR (255),
    STYLE  VARCHAR (255),
    UNIT_OF_MEASURE INT,
    WEIGHT FLOAT,
    PRICE FLOAT,
    COST FLOAT,
    CREATED_DATE  VARCHAR (255),
    CREATED_BY  VARCHAR (255),
    MODIFIED_DATE  VARCHAR (255),
    MODIFIED_BY VARCHAR (255),
    WHOLESALE_PRICE FLOAT
);

create table STAGE_PRODUCT_CATEGORY (
    PRODUCT_CATEGORY_ID INT,
    PRODUCT_CATEGORY VARCHAR (255),
    CREATED_DATE  VARCHAR (255),
    CREATED_BY  VARCHAR (255),
    MODIFIED_DATE  VARCHAR (255),
    MODIFIED_BY VARCHAR (255)
);

create table STAGE_PRODUCT_TYPE (
    PRODUCT_TYPE_ID INT,
    PRODUCT_CATEGORY_ID INT,
    PRODUCT_TYPE  VARCHAR (255),
    CREATED_DATE  VARCHAR (255),
    CREATED_BY  VARCHAR (255),
    MODIFIED_DATE  VARCHAR (255),
    MODIFIED_BY  VARCHAR (255)
);

create table STAGE_RESELLER (
    RESELLER_ID  VARCHAR (255),
    CONTACT   VARCHAR (255),
    EMAIL_ADDRESS   VARCHAR (255),
    ADDRESS   VARCHAR (255),
    CITY   VARCHAR (255),
    STATEPROVINCE   VARCHAR (255),
    COUNTRY   VARCHAR (255),
    POSTAL_CODE INT,
    PHONE_NUMBER   VARCHAR (255),
    CREATED_DATE   VARCHAR (255),
    CREATED_BY   VARCHAR (255),
    MODIFIED_DATE   VARCHAR (255),
    MODIFIED_BY   VARCHAR (255),
    RESELLER_NAME   VARCHAR (255)
);

create table STAGE_SALES_DETAIL (
    SALES_DETAIL_ID INT,
    SALES_HEADER INT,
    PRODUCT_ID INT,
    SALES_QUANTITY INT,
    SALES_AMOUNT FLOAT,
    CREATED_DATE    VARCHAR (255),
    CREATED_BY    VARCHAR (255),
    MODIFIED_DATE    VARCHAR (255),
    MODIFIED_BY    VARCHAR (255)
);

create table STAGE_SALES_HEADER (
    SALES_HEADER INT,
    DATE VARCHAR (255),
    CHANNEL_ID INT,
    STORE_ID INT,
    CUSTOMER_ID VARCHAR (255),
    RESELLER_ID  VARCHAR (255),
    CREATED_DATE     VARCHAR (255),
    CREATED_BY     VARCHAR (255),
    MODIFIED_DATE     VARCHAR (255),
    MODIFIED_BY    VARCHAR (255)
);

create table STAGE_STORE (
    STORE_ID INT,
    SUBSEGMENT INT,
    STORE_NUMBER INT,
    STORE_MANAGER VARCHAR (255),
    ADDRESS  VARCHAR (255),
    CITY  VARCHAR (255),
    STATEPROVINCE  VARCHAR (255),
    COUNTRY  VARCHAR (255),
    POSTAL_CODE INT,
    PHONE_NUMBER  VARCHAR (255),
    CREATED_DATE  VARCHAR (255),
    CREATED_BY  VARCHAR (255),
    MODIFIED_DATE  VARCHAR (255),
    MODIFIED_BY  VARCHAR (255)

);


create table STAGE_TARGET_DATA_CHANNEL (
    YEAR INT,
    CHANNEL_NAME VARCHAR (255),
    TARGET_NAME  VARCHAR (255),
    TARGET_SALES_AMOUNT INT
);

create table STAGE_TARGET_DATA_PRODUCT (
    PRODUCT_ID INT,
    PRODUCT  VARCHAR (255),
    YEAR INT,
    SALES_QUANTITY_TARGET INT
);


-- Impot data from CSVs into corresponding staging tables

COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_CHANNEL" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CHANNEL_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;



COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_CHANNEL_CATEGORY" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CHANNEL_CATEGORY_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;

COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_CUSTOMER" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CUSTOMER_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;

COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_PRODUCT" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."PRODUCT_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;


COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_PRODUCT_CATEGORY" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."PRODUCT_CATEGORY_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;

COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_PRODUCT_TYPE" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."PRODUCT_TYPE_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;

COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_RESELLER" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."RESELLER_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;

COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_SALES_DETAIL" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."SALES_DETAIL_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;

COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_SALES_HEADER" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."SALES_HEADER_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;

COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_STORE" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STORE_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;

COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_TARGET_DATA_CHANNEL" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."TARGET_DATA_CHANNEL_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;

COPY INTO "IMT_577_512_DB_MAX_MILLER"."PUBLIC"."STAGE_TARGET_DATA_PRODUCT" FROM '@"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."TARGET_DATA_PRODUCT_STAGE"'
FILE_FORMAT = '"IMT_577_512_DB_MAX_MILLER"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR = 'ABORT_STATEMENT' PURGE = FALSE;

select * from STAGE_TARGET_DATA_CHANNEL
